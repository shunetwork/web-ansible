---
# 部署配置到 Cisco 设备
- name: Deploy Configuration to Cisco Devices
  hosts: all
  gather_facts: no
  connection: network_cli
  
  tasks:
    - name: Backup current configuration before deployment
      ios_command:
        commands:
          - show running-config
      register: backup_config
    
    - name: Save backup to local
      copy:
        content: "{{ backup_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_pre_deploy_{{ ansible_date_time.date }}.cfg"
      delegate_to: localhost
      when: backup_before_deploy | default(true)
    
    - name: Deploy configuration
      ios_config:
        lines: "{{ config_lines }}"
        save_when: changed
      register: deploy_result
    
    - name: Verify configuration
      ios_command:
        commands:
          - show running-config | include {{ verify_string }}
      register: verify_result
      when: verify_string is defined
    
    - name: Display deployment result
      debug:
        msg: "Configuration deployed successfully. Changes: {{ deploy_result.changed }}"

