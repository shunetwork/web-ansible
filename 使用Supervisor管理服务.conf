# Supervisor 配置文件示例
# 用于生产环境管理所有服务进程
# 
# 安装 Supervisor: pip install supervisor
# 使用方法:
#   1. 复制此文件到 /etc/supervisor/conf.d/web-ansible.conf
#   2. 修改路径和用户配置
#   3. 执行: supervisorctl reread && supervisorctl update
#   4. 启动: supervisorctl start web-ansible:*

[group:web-ansible]
programs=django,celery-worker,celery-beat

# Django 应用（使用 Gunicorn）
[program:django]
command=/path/to/venv/bin/gunicorn web_ansible.wsgi:application -b 0.0.0.0:8000 -w 4 --timeout 120
directory=/path/to/web-ansible
user=www-data
autostart=true
autorestart=true
stdout_logfile=/path/to/web-ansible/logs/django.log
stderr_logfile=/path/to/web-ansible/logs/django_error.log
environment=PATH="/path/to/venv/bin"

# Celery Worker
[program:celery-worker]
command=/path/to/venv/bin/celery -A web_ansible worker -l info -c 4
directory=/path/to/web-ansible
user=www-data
autostart=true
autorestart=true
stdout_logfile=/path/to/web-ansible/logs/celery_worker.log
stderr_logfile=/path/to/web-ansible/logs/celery_worker_error.log
environment=PATH="/path/to/venv/bin"
stopwaitsecs=600
killasgroup=true
priority=998

# Celery Beat（定时任务）
[program:celery-beat]
command=/path/to/venv/bin/celery -A web_ansible beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
directory=/path/to/web-ansible
user=www-data
autostart=true
autorestart=true
stdout_logfile=/path/to/web-ansible/logs/celery_beat.log
stderr_logfile=/path/to/web-ansible/logs/celery_beat_error.log
environment=PATH="/path/to/venv/bin"
stopwaitsecs=60
priority=999

# 常用命令:
# supervisorctl status web-ansible:*           # 查看状态
# supervisorctl start web-ansible:*            # 启动所有服务
# supervisorctl stop web-ansible:*             # 停止所有服务
# supervisorctl restart web-ansible:*          # 重启所有服务
# supervisorctl restart web-ansible:django     # 重启单个服务
# supervisorctl tail -f web-ansible:django     # 查看日志

