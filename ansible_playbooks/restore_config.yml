---
# 恢复 Cisco 设备配置
- name: Restore Cisco Device Configuration
  hosts: all
  gather_facts: no
  connection: network_cli
  
  tasks:
    - name: Backup current configuration before restore
      ios_command:
        commands:
          - show running-config
      register: current_config
    
    - name: Save current config as backup
      copy:
        content: "{{ current_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_pre_restore_{{ ansible_date_time.date }}.cfg"
      delegate_to: localhost
    
    - name: Read configuration file to restore
      slurp:
        src: "{{ restore_config_file }}"
      register: restore_config
      delegate_to: localhost
    
    - name: Parse configuration
      set_fact:
        config_lines: "{{ (restore_config['content'] | b64decode).split('\n') | select() | list }}"
    
    - name: Apply restored configuration
      ios_config:
        lines: "{{ config_lines }}"
        save_when: changed
        replace: config
      register: restore_result
    
    - name: Verify configuration restored
      ios_command:
        commands:
          - show running-config
      register: verify_config
    
    - name: Display restore result
      debug:
        msg: |
          Configuration restore completed.
          Changed: {{ restore_result.changed }}
          Restored from: {{ restore_config_file }}

