# åå°å¯åŠ¨æœåŠ¡å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†å¤šç§åå°å¯åŠ¨å’Œç®¡ç†æœåŠ¡çš„æ–¹æ³•ï¼Œé€‚ç”¨äºä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œä½¿ç”¨åœºæ™¯ã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ–¹æ³•ä¸€ï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰](#æ–¹æ³•ä¸€ä½¿ç”¨è„šæœ¬æ¨è)
- [æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åå°å¯åŠ¨](#æ–¹æ³•äºŒæ‰‹åŠ¨åå°å¯åŠ¨)
- [æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Supervisorï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰](#æ–¹æ³•ä¸‰ä½¿ç”¨-supervisorç”Ÿäº§ç¯å¢ƒ)
- [æ–¹æ³•å››ï¼šä½¿ç”¨ systemdï¼ˆLinuxï¼‰](#æ–¹æ³•å››ä½¿ç”¨-systemdlinux)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å¿«é€Ÿå¼€å§‹

### ğŸ§ Linux / Mac

```bash
# 1. æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
chmod +x start_services.sh stop_services.sh status_services.sh

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡
./start_services.sh

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./status_services.sh

# 4. åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_services.sh
```

### ğŸªŸ Windows

```batch
REM 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡
start_services.bat

REM 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status_services.bat

REM 3. åœæ­¢æ‰€æœ‰æœåŠ¡
stop_services.bat
```

---

## æ–¹æ³•ä¸€ï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

### ç‰¹ç‚¹
âœ… ç®€å•æ˜“ç”¨ï¼Œä¸€é”®å¯åŠ¨
âœ… è‡ªåŠ¨åˆ›å»ºæ—¥å¿—æ–‡ä»¶
âœ… æ”¯æŒæœåŠ¡çŠ¶æ€æŸ¥çœ‹
âœ… é€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

### Linux/Mac ä½¿ç”¨æ–¹æ³•

#### 1. å¯åŠ¨æœåŠ¡

```bash
./start_services.sh
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
æ­£åœ¨å¯åŠ¨ Cisco ç½‘ç»œè®¾å¤‡è‡ªåŠ¨åŒ–ç®¡ç†å¹³å°...
âœ“ Redis å·²åœ¨åå°å¯åŠ¨
âœ“ Celery Worker å·²åœ¨åå°å¯åŠ¨
âœ“ Celery Beat å·²åœ¨åå°å¯åŠ¨
âœ“ Django æœåŠ¡å™¨å·²åœ¨åå°å¯åŠ¨ (PID: 12345)

==========================================
æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼
==========================================
Django ç®¡ç†åå°: http://127.0.0.1:8000/admin/
API åŸºç¡€åœ°å€: http://127.0.0.1:8000/api/
```

#### 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
./status_services.sh
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
==========================================
æœåŠ¡è¿è¡ŒçŠ¶æ€
==========================================
Redis:          âœ“ è¿è¡Œä¸­
Celery Worker:  âœ“ è¿è¡Œä¸­ (PID: 12346)
Celery Beat:    âœ“ è¿è¡Œä¸­ (PID: 12347)
Django:         âœ“ è¿è¡Œä¸­ (PID: 12345)
==========================================
```

#### 3. åœæ­¢æœåŠ¡

```bash
./stop_services.sh
```

#### 4. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ Django æ—¥å¿—
tail -f logs/django.log

# æŸ¥çœ‹ Celery Worker æ—¥å¿—
tail -f logs/celery_worker.log

# æŸ¥çœ‹ Celery Beat æ—¥å¿—
tail -f logs/celery_beat.log
```

### Windows ä½¿ç”¨æ–¹æ³•

#### 1. å¯åŠ¨æœåŠ¡

åŒå‡» `start_services.bat` æˆ–åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­è¿è¡Œï¼š

```batch
start_services.bat
```

#### 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

åŒå‡» `status_services.bat` æˆ–è¿è¡Œï¼š

```batch
status_services.bat
```

#### 3. åœæ­¢æœåŠ¡

åŒå‡» `stop_services.bat` æˆ–è¿è¡Œï¼š

```batch
stop_services.bat
```

---

## æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åå°å¯åŠ¨

### Linux/Mac

#### ä½¿ç”¨ nohup

```bash
# 1. å¯åŠ¨ Redis
redis-server --daemonize yes

# 2. å¯åŠ¨ Celery Worker
nohup celery -A web_ansible worker -l info > logs/celery_worker.log 2>&1 &

# 3. å¯åŠ¨ Celery Beat
nohup celery -A web_ansible beat -l info > logs/celery_beat.log 2>&1 &

# 4. å¯åŠ¨ Django
nohup python manage.py runserver 0.0.0.0:8000 > logs/django.log 2>&1 &
```

#### ä½¿ç”¨ screen

```bash
# 1. å¯åŠ¨ Redis
redis-server --daemonize yes

# 2. å¯åŠ¨ Celery Workerï¼ˆåœ¨æ–°çš„ screen ä¼šè¯ä¸­ï¼‰
screen -dmS celery_worker celery -A web_ansible worker -l info

# 3. å¯åŠ¨ Celery Beatï¼ˆåœ¨æ–°çš„ screen ä¼šè¯ä¸­ï¼‰
screen -dmS celery_beat celery -A web_ansible beat -l info

# 4. å¯åŠ¨ Djangoï¼ˆåœ¨æ–°çš„ screen ä¼šè¯ä¸­ï¼‰
screen -dmS django python manage.py runserver 0.0.0.0:8000

# æŸ¥çœ‹ä¼šè¯åˆ—è¡¨
screen -ls

# è¿›å…¥æŸä¸ªä¼šè¯
screen -r celery_worker

# é€€å‡ºä¼šè¯ï¼ˆä¸å…³é—­ï¼‰ï¼šæŒ‰ Ctrl+A ç„¶åæŒ‰ D
```

### Windows

#### ä½¿ç”¨ start å‘½ä»¤

```batch
REM 1. å¯åŠ¨ Redis
start /MIN redis-server

REM 2. å¯åŠ¨ Celery Worker
start /MIN cmd /c "celery -A web_ansible worker -l info > logs\celery_worker.log 2>&1"

REM 3. å¯åŠ¨ Celery Beat
start /MIN cmd /c "celery -A web_ansible beat -l info > logs\celery_beat.log 2>&1"

REM 4. å¯åŠ¨ Django
start /MIN cmd /c "python manage.py runserver 0.0.0.0:8000 > logs\django.log 2>&1"
```

---

## æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Supervisorï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### ç‰¹ç‚¹
âœ… è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
âœ… ç»Ÿä¸€ç®¡ç†å¤šä¸ªè¿›ç¨‹
âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ
âœ… æ”¯æŒæ—¥å¿—è½®è½¬

### å®‰è£… Supervisor

```bash
pip install supervisor
```

### é…ç½®æ–‡ä»¶

å‚è€ƒ `ä½¿ç”¨Supervisorç®¡ç†æœåŠ¡.conf` æ–‡ä»¶ï¼Œä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š

1. å°† `/path/to/` æ›¿æ¢ä¸ºå®é™…é¡¹ç›®è·¯å¾„
2. å°† `www-data` æ›¿æ¢ä¸ºå®é™…è¿è¡Œç”¨æˆ·

### ä½¿ç”¨æ–¹æ³•

```bash
# 1. å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp ä½¿ç”¨Supervisorç®¡ç†æœåŠ¡.conf /etc/supervisor/conf.d/web-ansible.conf

# 2. é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# 3. å¯åŠ¨æ‰€æœ‰æœåŠ¡
sudo supervisorctl start web-ansible:*

# 4. æŸ¥çœ‹çŠ¶æ€
sudo supervisorctl status web-ansible:*

# 5. é‡å¯æœåŠ¡
sudo supervisorctl restart web-ansible:*

# 6. åœæ­¢æœåŠ¡
sudo supervisorctl stop web-ansible:*

# 7. æŸ¥çœ‹æ—¥å¿—
sudo supervisorctl tail -f web-ansible:django
```

### å¸¸ç”¨å‘½ä»¤

```bash
# è¿›å…¥äº¤äº’æ¨¡å¼
sudo supervisorctl

# åœ¨äº¤äº’æ¨¡å¼ä¸­çš„å‘½ä»¤ï¼š
> status                    # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çŠ¶æ€
> start web-ansible:django  # å¯åŠ¨ Django
> stop web-ansible:*        # åœæ­¢æ‰€æœ‰æœåŠ¡
> restart web-ansible:*     # é‡å¯æ‰€æœ‰æœåŠ¡
> tail -f web-ansible:django stdout  # å®æ—¶æŸ¥çœ‹æ—¥å¿—
> exit                      # é€€å‡º
```

---

## æ–¹æ³•å››ï¼šä½¿ç”¨ systemdï¼ˆLinuxï¼‰

### ç‰¹ç‚¹
âœ… ç³»ç»Ÿçº§æœåŠ¡ç®¡ç†
âœ… å¼€æœºè‡ªå¯åŠ¨
âœ… å´©æºƒè‡ªåŠ¨é‡å¯
âœ… æ ‡å‡†åŒ–ç®¡ç†

### é…ç½®æ–¹æ³•

å‚è€ƒ `ä½¿ç”¨systemdç®¡ç†æœåŠ¡.md` æ–‡æ¡£ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. **åˆ›å»ºæœåŠ¡æ–‡ä»¶**
   - `/etc/systemd/system/web-ansible-django.service`
   - `/etc/systemd/system/web-ansible-celery-worker.service`
   - `/etc/systemd/system/web-ansible-celery-beat.service`

2. **é‡è½½é…ç½®**
   ```bash
   sudo systemctl daemon-reload
   ```

3. **å¯ç”¨å¼€æœºè‡ªå¯**
   ```bash
   sudo systemctl enable web-ansible-django
   sudo systemctl enable web-ansible-celery-worker
   sudo systemctl enable web-ansible-celery-beat
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   sudo systemctl start web-ansible-django
   sudo systemctl start web-ansible-celery-worker
   sudo systemctl start web-ansible-celery-beat
   ```

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status web-ansible-django

# å¯åŠ¨æœåŠ¡
sudo systemctl start web-ansible-django

# åœæ­¢æœåŠ¡
sudo systemctl stop web-ansible-django

# é‡å¯æœåŠ¡
sudo systemctl restart web-ansible-django

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u web-ansible-django -f
```

---

## æœåŠ¡ç«¯å£è¯´æ˜

| æœåŠ¡ | é»˜è®¤ç«¯å£ | è¯´æ˜ |
|------|---------|------|
| Django | 8000 | Web æœåŠ¡å™¨ |
| Redis | 6379 | æ¶ˆæ¯é˜Ÿåˆ— |

è®¿é—®åœ°å€ï¼š
- **ç®¡ç†åå°**: http://127.0.0.1:8000/admin/
- **API**: http://127.0.0.1:8000/api/

---

## æ—¥å¿—æ–‡ä»¶ä½ç½®

æ‰€æœ‰æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ `logs/` ç›®å½•ä¸‹ï¼š

```
logs/
â”œâ”€â”€ django.log           # Django åº”ç”¨æ—¥å¿—
â”œâ”€â”€ celery_worker.log    # Celery Worker æ—¥å¿—
â”œâ”€â”€ celery_beat.log      # Celery Beat æ—¥å¿—
â””â”€â”€ ansible.log          # Ansible æ‰§è¡Œæ—¥å¿—
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆLinux/Macï¼‰
tail -f logs/django.log

# æŸ¥çœ‹æœ€å 100 è¡Œ
tail -n 100 logs/django.log

# æœç´¢é”™è¯¯
grep -i error logs/django.log
```

---

## å¸¸è§é—®é¢˜

### Q1: Redis è¿æ¥å¤±è´¥

**ç°è±¡**: `Connection refused: localhost:6379`

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
redis-cli ping

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨ Redis
# Linux/Mac
redis-server --daemonize yes

# Windows
redis-server
```

### Q2: Celery Worker æ— æ³•å¯åŠ¨

**ç°è±¡**: Worker å¯åŠ¨åç«‹å³é€€å‡º

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥ Redis è¿æ¥
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—: `cat logs/celery_worker.log`
3. ç¡®è®¤è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
4. æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´å®‰è£…

### Q3: ç«¯å£è¢«å ç”¨

**ç°è±¡**: `Address already in use: 0.0.0.0:8000`

**è§£å†³æ–¹æ³•**:
```bash
# Linux/Mac - æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8000
kill -9 <PID>

# Windows - æŸ¥æ‰¾å¹¶ç»ˆæ­¢è¿›ç¨‹
netstat -ano | findstr :8000
taskkill /PID <PID> /F
```

### Q4: æƒé™é”™è¯¯

**ç°è±¡**: `Permission denied`

**è§£å†³æ–¹æ³•**:
```bash
# æ·»åŠ è„šæœ¬æ‰§è¡Œæƒé™
chmod +x start_services.sh

# ä¿®æ”¹æ—¥å¿—ç›®å½•æƒé™
chmod 755 logs/
```

### Q5: å¦‚ä½•æŸ¥çœ‹æŸä¸ªæœåŠ¡æ˜¯å¦åœ¨è¿è¡Œï¼Ÿ

```bash
# Linux/Mac
ps aux | grep celery
ps aux | grep django
ps aux | grep redis

# Windows
tasklist | findstr celery
tasklist | findstr python
tasklist | findstr redis
```

### Q6: å¦‚ä½•å®Œå…¨æ¸…ç†å¹¶é‡å¯æ‰€æœ‰æœåŠ¡ï¼Ÿ

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
./stop_services.sh   # æˆ– stop_services.bat

# 2. æ¸…ç† PID æ–‡ä»¶
rm -f logs/*.pid

# 3. æ¸…ç† Celery ç¼“å­˜
celery -A web_ansible purge

# 4. é‡æ–°å¯åŠ¨
./start_services.sh  # æˆ– start_services.bat
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Celery Worker æ•°é‡

æ ¹æ® CPU æ ¸å¿ƒæ•°è°ƒæ•´ worker æ•°é‡ï¼š

```bash
# 4 ä¸ªå¹¶å‘ worker
celery -A web_ansible worker -l info -c 4
```

### 2. Django ç”Ÿäº§ç¯å¢ƒ

ä½¿ç”¨ Gunicorn æ›¿ä»£ runserverï¼š

```bash
# å®‰è£… Gunicorn
pip install gunicorn

# å¯åŠ¨ï¼ˆ4 ä¸ª workerï¼‰
gunicorn web_ansible.wsgi:application -b 0.0.0.0:8000 -w 4
```

### 3. Redis ä¼˜åŒ–

åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½® Redis æŒä¹…åŒ–ï¼š

```bash
redis-server --appendonly yes --save 60 1000
```

---

## ç›‘æ§å»ºè®®

### 1. è¿›ç¨‹ç›‘æ§

```bash
# ç›‘æ§è„šæœ¬
watch -n 5 './status_services.sh'
```

### 2. æ—¥å¿—ç›‘æ§

```bash
# å®æ—¶ç›‘æ§æ‰€æœ‰æ—¥å¿—
tail -f logs/*.log
```

### 3. èµ„æºä½¿ç”¨ç›‘æ§

```bash
# CPU å’Œå†…å­˜ä½¿ç”¨
top -p $(pgrep -d',' -f 'celery|django|redis')
```

---

## æ¨èä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æ¨èæ–¹æ³• | ä¼˜ç‚¹ |
|------|---------|------|
| å¼€å‘ç¯å¢ƒ | è„šæœ¬å¯åŠ¨ | ç®€å•å¿«é€Ÿ |
| æµ‹è¯•ç¯å¢ƒ | Supervisor | ç¨³å®šå¯é  |
| ç”Ÿäº§ç¯å¢ƒ | systemd | ç³»ç»Ÿé›†æˆ |
| Windows | æ‰¹å¤„ç†è„šæœ¬ | åŸç”Ÿæ”¯æŒ |

---

## æ€»ç»“

âœ… **å¼€å‘è°ƒè¯•**: ä½¿ç”¨ `start_services.sh` æˆ– `start_services.bat`
âœ… **ç”Ÿäº§éƒ¨ç½²**: ä½¿ç”¨ Supervisor æˆ– systemd
âœ… **å®šæœŸæ£€æŸ¥**: ä½¿ç”¨ `status_services.sh` æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
âœ… **é—®é¢˜æ’æŸ¥**: æŸ¥çœ‹ `logs/` ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰

