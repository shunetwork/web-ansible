---
# Cisco 设备健康检查
- name: Cisco Device Health Check
  hosts: all
  gather_facts: no
  connection: network_cli
  
  tasks:
    - name: Get device version
      ios_command:
        commands:
          - show version
      register: version_output
    
    - name: Get interface status
      ios_command:
        commands:
          - show ip interface brief
      register: interface_output
    
    - name: Get CPU usage
      ios_command:
        commands:
          - show processes cpu | include CPU
      register: cpu_output
    
    - name: Get memory usage
      ios_command:
        commands:
          - show memory statistics
      register: memory_output
    
    - name: Get environment status
      ios_command:
        commands:
          - show environment all
      register: environment_output
      ignore_errors: yes
    
    - name: Compile health check report
      set_fact:
        health_report:
          hostname: "{{ inventory_hostname }}"
          version: "{{ version_output.stdout[0] | regex_search('Version ([^,]+)', '\\1') | first }}"
          interfaces: "{{ interface_output.stdout[0] }}"
          cpu: "{{ cpu_output.stdout[0] }}"
          memory: "{{ memory_output.stdout[0] }}"
          environment: "{{ environment_output.stdout[0] | default('N/A') }}"
    
    - name: Display health check report
      debug:
        var: health_report
    
    - name: Save health check report
      copy:
        content: "{{ health_report | to_nice_json }}"
        dest: "{{ report_dir }}/{{ inventory_hostname }}_health_{{ ansible_date_time.date }}.json"
      delegate_to: localhost

